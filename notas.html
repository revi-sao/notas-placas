<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>OBS</title>
<style>
body { font-family: Arial, sans-serif; margin:20px; background:#f5f5f5; }
h1 { color:#1E90FF; text-align:center; }
.container { max-width:600px; margin:0 auto; }
.historico { display:flex; flex-direction:column-reverse; margin-bottom:15px; }
.nota-item { background:#fff; padding:12px; border-radius:8px; box-shadow:0 0 5px rgba(0,0,0,0.1); margin-bottom:10px; display:flex; justify-content:space-between; align-items:center; word-break:break-word; transition:transform 0.2s; }
.nota-item.recente { font-size:1.1em; background:#e0f0ff; transform:scale(1.02); }
.nota-text { flex-grow:1; margin-right:10px; }
.nota-buttons button { margin-left:5px; padding:5px 8px; border:none; border-radius:4px; cursor:pointer; color:white; }
.nota-buttons button.edit { background:#2196F3; }
.nota-buttons button.delete { background:#f44336; }
.input-area { display:flex; background:#fff; border-radius:50px; box-shadow:0 0 5px rgba(0,0,0,0.1); padding:5px 10px; align-items:center; }
.input-area input { flex-grow:1; border:none; padding:10px; border-radius:50px; outline:none; font-size:14px; }
.input-area button { background:#1E90FF; color:white; border:none; border-radius:50%; width:40px; height:40px; margin-left:10px; cursor:pointer; display:flex; align-items:center; justify-content:center; font-size:18px; }
.input-area button:hover { background:#187bcd; }
</style>
</head>
<body>

<h1>OBS</h1>
<div class="container">
    <div class="historico" id="historico"></div>
    <div class="input-area">
        <input type="text" id="nota" placeholder="Digite sua observação...">
        <button id="enviar">&#10148;</button>
    </div>
</div>

<!-- Firebase Modular SDK -->
<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.3.0/firebase-app.js";
import { getFirestore, collection, doc, addDoc, deleteDoc, updateDoc, query, orderBy, onSnapshot, serverTimestamp } from "https://www.gstatic.com/firebasejs/12.3.0/firebase-firestore.js";

// Configuração do Firebase
const firebaseConfig = {
    apiKey: "AIzaSyC6cB5JAT9Q2NbLSJbXk6Cw8PCihlv7czA",
    authDomain: "historico-2a73e.firebaseapp.com",
    projectId: "historico-2a73e",
    storageBucket: "historico-2a73e.firebasestorage.app",
    messagingSenderId: "663163458965",
    appId: "1:663163458965:web:454e306f327f690351929c"
};

// Inicializa Firebase
const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

const params = new URLSearchParams(window.location.search);
const placaRaw = params.get('placa') || "geral";
const placa = placaRaw.replace(/[^a-zA-Z0-9_-]/g, "_");

const input = document.getElementById('nota');
const enviarBtn = document.getElementById('enviar');
const historicoDiv = document.getElementById('historico');

// Função para renderizar notas
function renderNotas(notas) {
    historicoDiv.innerHTML = '';
    notas.slice().reverse().forEach(nota => {
        const div = document.createElement('div');
        div.className = 'nota-item';
        if(nota.recente) div.classList.add('recente');
        div.innerHTML = `
            <div class="nota-text">${nota.texto}</div>
            <div class="nota-buttons">
                <button class="edit">Editar</button>
                <button class="delete">Excluir</button>
            </div>
        `;

        div.querySelector('.edit').addEventListener('click', async () => {
            const novoTexto = prompt('Edite a nota:', nota.texto);
            if(novoTexto !== null){
                await updateDoc(doc(db, "notas", placa, "itens", nota.id), { texto: novoTexto });
            }
        });

        div.querySelector('.delete').addEventListener('click', async () => {
            if(confirm('Deseja realmente excluir esta nota?')){
                await deleteDoc(doc(db, "notas", placa, "itens", nota.id));
            }
        });

        historicoDiv.appendChild(div);
    });
}

// Observa notas em tempo real
const q = query(collection(db, "notas", placa, "itens"), orderBy("timestamp"));
onSnapshot(q, snapshot => {
    const notas = snapshot.docs.map((doc, index) => ({
        id: doc.id,
        texto: doc.data().texto,
        recente: index === snapshot.docs.length - 1
    }));
    renderNotas(notas);
});

// Enviar nova nota
async function enviarNota() {
    const texto = input.value.trim();
    if(texto === '') return;
    await addDoc(collection(db, "notas", placa, "itens"), {
        texto: texto,
        timestamp: serverTimestamp()
    });
    input.value = '';
}

enviarBtn.addEventListener('click', enviarNota);
input.addEventListener('keypress', e => { if(e.key === 'Enter') enviarNota(); });

</script>
</body>
</html>
